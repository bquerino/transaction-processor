# Transaction Processor - Ledger Application

A Rust-based ledger application using Diesel ORM and PostgreSQL for managing accounts and transactions.

## Architecture

This project follows a clean architecture pattern with the following structure:

```
transaction-processor/
├── app/                    # Application code
│   ├── src/
│   │   ├── main.rs        # Application entry point
│   │   ├── lib.rs         # Core library functions
│   │   ├── models.rs      # Data models
│   │   └── schema.rs      # Database schema (generated by Diesel)
│   ├── migrations/        # Database migrations
│   │   ├── 00000000000000_diesel_initial_setup/
│   │   ├── 2024-01-01-000000_create_accounts/
│   │   └── 2024-01-01-000001_create_transactions/
│   ├── Cargo.toml         # Rust dependencies
│   ├── diesel.toml        # Diesel ORM configuration
│   └── .env.example       # Environment variables template
└── infra/                 # Infrastructure configuration
    ├── docker-compose.yml # PostgreSQL container setup
    └── init.sql           # Database initialization script
```

### Components

- **Models**: Define the data structures for Accounts and Transactions
- **Schema**: Auto-generated Diesel schema mapping to database tables
- **Migrations**: Version-controlled database schema changes
- **Database Pool**: R2D2 connection pooling for efficient database access

### Database Schema

#### Accounts Table
- `id`: Primary key (auto-increment)
- `account_number`: Unique account identifier
- `account_name`: Name of the account holder
- `balance`: Current balance (stored as bigint for precision)
- `created_at`: Timestamp of account creation
- `updated_at`: Timestamp of last update

#### Transactions Table
- `id`: Primary key (auto-increment)
- `from_account_id`: Source account (nullable for deposits)
- `to_account_id`: Destination account (nullable for withdrawals)
- `amount`: Transaction amount (must be positive)
- `transaction_type`: Type of transaction (e.g., deposit, withdrawal, transfer)
- `description`: Optional transaction description
- `created_at`: Timestamp of transaction

## Prerequisites

- **Rust** (1.70+): Install from [rustup.rs](https://rustup.rs/)
- **Docker** & **Docker Compose**: For running PostgreSQL
- **Diesel CLI**: Install with `cargo install diesel_cli --no-default-features --features postgres`

## How to Run Locally

### 1. Start the PostgreSQL Database

Navigate to the `infra` directory and start the PostgreSQL container:

```bash
cd infra
docker-compose up -d
```

Verify the database is running:

```bash
docker-compose ps
```

### 2. Set Up Environment Variables

Copy the example environment file and configure it:

```bash
cd ../app
cp .env.example .env
```

The default `.env` should contain:
```
DATABASE_URL=postgres://ledger_user:ledger_password@localhost:5432/ledger_db
```

### 3. Run Database Migrations

Apply the database migrations using Diesel CLI:

```bash
diesel migration run
```

To revert the last migration (if needed):
```bash
diesel migration revert
```

### 4. Build and Run the Application

Build the application:

```bash
cargo build
```

Run the application:

```bash
cargo run
```

For production builds:
```bash
cargo build --release
./target/release/transaction-processor
```

## Development

### Running Tests

```bash
cargo test
```

### Code Formatting

```bash
cargo fmt
```

### Linting

```bash
cargo clippy
```

### Adding New Migrations

To create a new migration:

```bash
diesel migration generate <migration_name>
```

This creates a new directory in `migrations/` with `up.sql` and `down.sql` files.

## Available Operations

The application provides the following core operations:

- **Create Account**: Create a new account with initial balance
- **Create Transaction**: Record a new transaction (deposit, withdrawal, transfer)
- **Get Account Balance**: Retrieve the current balance of an account
- **List Accounts**: Get all accounts
- **List Transactions**: Get all transactions

## Stopping the Infrastructure

To stop the PostgreSQL container:

```bash
cd infra
docker-compose down
```

To stop and remove all data:

```bash
docker-compose down -v
```

## Technology Stack

- **Language**: Rust 2021 Edition
- **ORM**: Diesel 2.2
- **Database**: PostgreSQL 16
- **Connection Pooling**: R2D2
- **Environment Management**: dotenvy
- **Serialization**: Serde + Serde JSON
- **Date/Time**: Chrono

## License

See LICENSE file for details.